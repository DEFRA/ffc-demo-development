#!/usr/bin/env sh

##
# Stop script
#
# Stop all services managed by this project.
# Expects each service to have a stop script at `scripts/stop`.
##

set -e
projectRoot=$(a="/$0"; a=${a%/*}; a=${a:-.}; a=${a#/}/; cd "$a/.." || return; pwd)

(
  cd "${projectRoot}/.."

  echo "Stopping services..."
  mine-support/scripts/stop
  mine-support-api-gateway/scripts/stop
  mine-support-calculation-service/scripts/stop
  mine-support-claim-service/scripts/stop
  mine-support-payment-service/scripts/stop
  mine-support-user-service/scripts/stop
)

# Check whether mine-support network exists and is no longer in use
if [ ! -z "$(docker network ls --filter name=^mine-support$ --format={{.Name}})" ] \
  && [ "$(docker network inspect -f {{.Containers}} mine-support &>/dev/null)" = "map[]" ] \
; then
  echo "Removing mine-support network"
  docker network rm mine-support
fi
